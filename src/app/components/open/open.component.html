<div class="container mt-5">
	<div class="row justify-content-center">
		<div class="col-md-8">
			<div class="card">
				<div class="card-header">
					<h2 class="card-title mb-0">Open a results file</h2>
					<!-- <p class="text-muted mb-0">Upload a results file or provide a URL to view CQL test results</p> -->
				</div>
				<div class="card-body">
					<!-- File Upload Section -->
					<div class="mb-4">
						<h5>Open Local File</h5>
						<div class="input-group">
							<input type="file" class="form-control" id="file-input" accept=".json"
								(change)="onFileSelected($event)" [disabled]="isLoading()">
							<!-- Action buttons shown when validation fails -->
							<button *ngIf="validationErrors().length > 0 && selectedFile()" class="btn btn-outline-secondary" type="button" (click)="clearSelectedFile()"
								[disabled]="isLoading()" title="Clear selected file">
								<i class="bi bi-x-circle"></i> Clear
							</button>
							<button *ngIf="validationErrors().length > 0 && selectedFile()" class="btn btn-outline-secondary" type="button" (click)="rerunValidation()"
								[disabled]="isLoading()" title="Rerun validation">
								<i class="bi bi-arrow-clockwise"></i> Retry
							</button>
						</div>
						<div class="form-text">Select a JSON file containing CQL test results. It will <b>not</b> be uploaded to any server.</div>
					</div>

					<div class="text-center mb-4">
						<span class="text-muted">OR</span>
					</div>

					<!-- URL Input Section -->
					<div class="mb-4">
						<h5>Load from URL</h5>
						<div class="input-group">
							<input id="url-input" type="url" class="form-control" placeholder="https://example.com/results.json"
								[ngModel]="urlInput()" (ngModelChange)="urlInput.set($event)" [disabled]="isLoading()">
							<button id="url-load-button" class="btn btn-primary" type="button" (click)="onUrlSubmit()"
								[disabled]="isLoading() || !urlInput().trim()">
								Load
							</button>
						</div>
						<div class="form-text">Enter a URL to a JSON file containing CQL test results.</div>
					</div>

					<div class="text-center mb-4">
						<span class="text-muted">OR</span>
					</div>

					<!-- Example File Section -->
					<div class="mb-4">
						<h5>Load Example</h5>
						<div class="d-grid">
							<button id="example-load-button" class="btn btn-outline-secondary" type="button" (click)="onLoadExample()"
								[disabled]="isLoading()">
								<i class="bi bi-file-earmark-code me-2"></i>Load Example Results File
							</button>
						</div>
						<div class="form-text">Load the bundled example CQL test results file.</div>
					</div>

					<div class="text-center mb-4">
						<span class="text-muted">OR</span>
					</div>

					<!-- Index File Section -->
					<div class="mb-4">
						<h5>Load from Index</h5>
						<div class="input-group mb-3">
							<input id="index-url-input" type="url" class="form-control" placeholder="https://example.com/index.json"
								[ngModel]="indexUrl()" (ngModelChange)="indexUrl.set($event)" [disabled]="isLoading() || indexLoading()">
							<button id="index-load-button" class="btn btn-primary" type="button" (click)="onLoadIndexFile()"
								[disabled]="isLoading() || indexLoading() || !indexUrl().trim()">
								Load Index
							</button>
						</div>
						<div class="form-text">Enter a URL to an index JSON file containing a "files" array.</div>
						
						<!-- Index Loading State -->
						<div *ngIf="indexLoading()" class="text-center">
							<div class="spinner-border spinner-border-sm text-primary" role="status">
								<span class="visually-hidden">Loading index...</span>
							</div>
							<span class="ms-2">Loading index file...</span>
						</div>

						<!-- Index Error -->
						<div *ngIf="indexError()" class="alert alert-danger" role="alert">
							<h6 class="alert-heading">Index Error</h6>
							<p class="mb-0">{{ indexError() }}</p>
						</div>

						<!-- Index Files List -->
						<div *ngIf="indexFiles().length > 0" class="mt-3">
							<div class="d-flex justify-content-between align-items-center mb-3">
								<h6 class="mb-0">Available Files:</h6>
								<button class="btn btn-primary" type="button" 
									(click)="onOpenDashboard()" [disabled]="isLoading()">
									<i class="bi bi-graph-up me-2"></i>Summary Dashboard
								</button>
							</div>
							<div class="list-group">
								<div *ngFor="let filename of indexFiles()" class="list-group-item d-flex justify-content-between align-items-center">
									<span class="text-truncate me-2" [title]="filename">
										<i class="bi bi-file-earmark-json me-2"></i>{{ filename }}
									</span>
									<button class="btn btn-sm btn-outline-primary" type="button" 
										(click)="onLoadFileFromIndex(filename)" [disabled]="isLoading()">
										Load
									</button>
								</div>
							</div>
						</div>
					</div>

<hr>
					<!-- Settings Section -->
					<div class="mb-4">
						<h5>Settings</h5>
						<div class="form-check form-switch">
							<input class="form-check-input" type="checkbox" id="validate-schema-switch"
								[(ngModel)]="settingsService.settings().validateSchema"
								(ngModelChange)="onValidateSchemaChange()" [disabled]="isLoading()">
							<label class="form-check-label" for="validate-schema-switch">
								<i class="bi bi-check-circle me-1"></i>Validate against schema before loading
							</label>
						</div>
						<div class="form-text mt-2">
							<small class="text-muted">
								When enabled, files will be validated against the CQL test results schema before
								loading.
								Disable this for faster loading or when working with non-standard files.
							</small>
						</div>
					</div>

					<!-- Loading State -->
					<div *ngIf="isLoading()" class="text-center">
						<div class="spinner-border text-primary" role="status">
							<span class="visually-hidden">Loading...</span>
						</div>
						<p class="mt-2">Loading and validating results...</p>
					</div>

					<!-- Error Messages -->
					<div *ngIf="errorMessage()" class="alert alert-danger" role="alert">
						<h6 class="alert-heading">Error</h6>
						<p class="mb-0">{{ errorMessage() }}</p>
					</div>

					<!-- Validation Errors -->
					<div *ngIf="validationErrors().length > 0" class="alert alert-warning" role="alert">
						<h6 class="alert-heading">Validation Errors</h6>
						<p>The file does not conform to the expected schema:</p>
						<ul class="mb-0">
							<li *ngFor="let error of validationErrors()">{{ error }}</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>