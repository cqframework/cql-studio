<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 id="dashboard-title" class="mb-1">
                        <i class="bi bi-graph-up me-2"></i>All Results Summary Dashboard
                    </h1>
                    <p class="text-muted mb-0">Compare and analyze CQL test results across multiple files</p>
                </div>
                <button id="back-to-home-btn" class="btn btn-outline-secondary" (click)="onBackToIndex()">
                    <i class="bi bi-arrow-left me-2"></i>Back to Home
                </button>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" *ngIf="isLoading()" class="text-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-3">Loading test results...</p>
    </div>

    <!-- Error State -->
    <div id="error-state" *ngIf="errorMessage()" class="alert alert-danger" role="alert">
        <h6 class="alert-heading">Error</h6>
        <p class="mb-0">{{ errorMessage() }}</p>
    </div>

    <!-- Dashboard Content -->
    <div *ngIf="!isLoading() && !errorMessage()">
        <!-- Charts Row -->
        <div class="row mb-4">
            <!-- Engine Comparison Chart -->
            <div class="col-md-6">
                <div id="engine-comparison-chart" class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Results by Engine</h5>
                    </div>
                    <div class="card-body">
                        <div style="height: 300px;">
                            <canvas id="engine-chart-canvas" baseChart [data]="fileComparisonChartData()" [options]="fileComparisonChartOptions"
                                type="bar">
                            </canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Summary Chart -->
            <div class="col-md-6">
                <div id="summary-chart" class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Aggregated Summary</h5>
                    </div>
                    <div class="card-body">
                        <div style="height: 300px;">
                            <canvas id="summary-chart-canvas" baseChart [data]="summaryChartData()" [options]="summaryChartOptions"
                                type="doughnut">
                            </canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters & Controls Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div id="filters-controls-card" class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Filters & Controls</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- Left Column: File Selection and Controls -->
                            <div class="col-md-4">
                                <!-- File Selection -->
                                <div id="file-selection-section" class="mb-4">
                                    <label class="form-label">Files to Include:</label>
                                    <div class="mb-2">
                                        <button id="select-all-btn" class="btn btn-sm btn-outline-primary me-2"
                                            (click)="onSelectAllFiles()">Select All</button>
                                        <button id="deselect-all-btn" class="btn btn-sm btn-outline-secondary"
                                            (click)="onDeselectAllFiles()">Deselect All</button>
                                    </div>
                                    <div class="form-check" *ngFor="let item of dashboardData()">
                                        <input class="form-check-input" type="checkbox" [id]="'file-' + item.filename"
                                            [checked]="selectedFiles().includes(item.filename)"
                                            (change)="onFileSelectionChange(item.filename, $event.target.checked)">
                                        <label class="form-check-label" [for]="'file-' + item.filename">
                                            {{ item.filename }}
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">

                                <!-- Status Filter -->
                                <div class="form-floating mb-3">
                                    <select id="status-filter" class="form-select" [ngModel]="statusFilter()"
                                        (ngModelChange)="onStatusFilterChange($event)">
                                        <option value="all">All Statuses</option>
                                        <option value="pass">Has Passes</option>
                                        <option value="fail">Has Failures</option>
                                        <option value="skip">Has Skips</option>
                                        <option value="error">Has Errors</option>
                                    </select>
                                    <label for="status-filter">Status Filter</label>
                                </div>

                                <!-- Sort Options -->
                                <div class="form-floating mb-3">
                                    <select id="sort-by" class="form-select" [ngModel]="sortBy()"
                                        (ngModelChange)="onSortChange($event)">
                                        <option value="filename">Filename</option>
                                        <option value="passCount">Pass Count</option>
                                        <option value="failCount">Fail Count</option>
                                        <option value="totalTests">Total Tests</option>
                                        <option value="timestamp">Timestamp</option>
                                    </select>
                                    <label for="sort-by">Sort By</label>
                                </div>

                                <!-- Sort Order -->
                                <div class="mb-3">
                                    <button id="sort-order-btn" class="btn btn-outline-secondary w-100" (click)="onSortOrderChange()">
                                        <i class="bi" [class.bi-sort-alpha-down]="sortOrder() === 'asc'"
                                            [class.bi-sort-alpha-up]="sortOrder() === 'desc'"></i>
                                        {{ sortOrder() === 'asc' ? 'Ascending' : 'Descending' }}
                                    </button>
                                </div>
                            </div>

                            <!-- Right Column: Summary Cards -->
                            <div class="col-md-4">
                                <div id="summary-cards-row" class="row">
                                    <div class="col-6 mb-3">
                                        <div id="total-passed-card" class="card text-center">
                                            <div class="card-body">
                                                <h5 class="card-title text-success">{{ totalPass() }}</h5>
                                                <p class="card-text">Total Passed</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div id="total-failed-card" class="card text-center">
                                            <div class="card-body">
                                                <h5 class="card-title text-danger">{{ totalFail() }}</h5>
                                                <p class="card-text">Total Failed</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div id="total-skipped-card" class="card text-center">
                                            <div class="card-body">
                                                <h5 class="card-title text-warning">{{ totalSkip() }}</h5>
                                                <p class="card-text">Total Skipped</p>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div id="total-errors-card" class="card text-center">
                                            <div class="card-body">
                                                <h5 class="card-title text-secondary">{{ totalError() }}</h5>
                                                <p class="card-text">Total Errors</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Results Table -->
        <div class="row">
            <div class="col-12">
                <div id="detailed-results-card" class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Detailed Results</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table id="results-table" class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th id="engine-header" class="fw-bold text-primary" style="cursor: pointer;" (click)="onSortBy('engine')" title="Click to sort by Engine">
                                            Engine
                                            <i class="bi ms-1" [class.bi-sort-alpha-down]="sortBy() === 'engine' && sortOrder() === 'asc'" [class.bi-sort-alpha-up]="sortBy() === 'engine' && sortOrder() === 'desc'"></i>
                                        </th>
                                        <th id="filename-header" style="cursor: pointer;" (click)="onSortBy('filename')" title="Click to sort by Filename">
                                            Filename
                                            <i class="bi ms-1" [class.bi-sort-alpha-down]="sortBy() === 'filename' && sortOrder() === 'asc'" [class.bi-sort-alpha-up]="sortBy() === 'filename' && sortOrder() === 'desc'"></i>
                                        </th>
                                        <th id="timestamp-header" style="cursor: pointer;" (click)="onSortBy('timestamp')" title="Click to sort by Timestamp">
                                            Timestamp
                                            <i class="bi ms-1" [class.bi-sort-alpha-down]="sortBy() === 'timestamp' && sortOrder() === 'asc'" [class.bi-sort-alpha-up]="sortBy() === 'timestamp' && sortOrder() === 'desc'"></i>
                                        </th>
                                        <th id="pass-header" class="text-center" style="cursor: pointer;" (click)="onSortBy('passCount')" title="Click to sort by Pass Count">
                                            Pass
                                            <i class="bi ms-1" [class.bi-sort-alpha-down]="sortBy() === 'passCount' && sortOrder() === 'asc'" [class.bi-sort-alpha-up]="sortBy() === 'passCount' && sortOrder() === 'desc'"></i>
                                        </th>
                                        <th id="fail-header" class="text-center" style="cursor: pointer;" (click)="onSortBy('failCount')" title="Click to sort by Fail Count">
                                            Fail
                                            <i class="bi ms-1" [class.bi-sort-alpha-down]="sortBy() === 'failCount' && sortOrder() === 'asc'" [class.bi-sort-alpha-up]="sortBy() === 'failCount' && sortOrder() === 'desc'"></i>
                                        </th>
                                        <th id="skip-header" class="text-center" style="cursor: pointer;" (click)="onSortBy('skipCount')" title="Click to sort by Skip Count">
                                            Skip
                                            <i class="bi ms-1" [class.bi-sort-alpha-down]="sortBy() === 'skipCount' && sortOrder() === 'asc'" [class.bi-sort-alpha-up]="sortBy() === 'skipCount' && sortOrder() === 'desc'"></i>
                                        </th>
                                        <th id="error-header" class="text-center" style="cursor: pointer;" (click)="onSortBy('errorCount')" title="Click to sort by Error Count">
                                            Error
                                            <i class="bi ms-1" [class.bi-sort-alpha-down]="sortBy() === 'errorCount' && sortOrder() === 'asc'" [class.bi-sort-alpha-up]="sortBy() === 'errorCount' && sortOrder() === 'desc'"></i>
                                        </th>
                                        <th id="total-header" class="text-center" style="cursor: pointer;" (click)="onSortBy('totalTests')" title="Click to sort by Total Tests">
                                            Total
                                            <i class="bi ms-1" [class.bi-sort-alpha-down]="sortBy() === 'totalTests' && sortOrder() === 'asc'" [class.bi-sort-alpha-up]="sortBy() === 'totalTests' && sortOrder() === 'desc'"></i>
                                        </th>
                                        <th id="actions-header" class="text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let item of filteredData()">
                                        <td class="fw-bold text-primary" style="cursor: pointer;"
                                            (click)="onViewFile(item.filename)" title="Click to view file details">
                                            <i class="bi bi-gear-fill me-2"></i>
                                            {{ item.engine }}
                                        </td>
                                        <td>
                                            <i class="bi bi-file-earmark-json me-2"></i>
                                            {{ item.filename }}
                                        </td>
                                        <td>
                                            <small>{{ item.timestamp | date:'short' }}</small>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-success">{{ item.summary.passCount }}</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-danger">{{ item.summary.failCount }}</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-warning">{{ item.summary.skipCount }}</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="badge bg-secondary">{{ item.summary.errorCount }}</span>
                                        </td>
                                        <td class="text-center">
                                            <strong>{{ item.summary.passCount + item.summary.failCount +
                                                item.summary.skipCount + item.summary.errorCount }}</strong>
                                        </td>
                                        <td class="text-center">
                                            <button class="btn btn-sm btn-outline-primary view-file-btn"
                                                (click)="onViewFile(item.filename)">
                                                <i class="bi bi-eye me-1"></i>View
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>